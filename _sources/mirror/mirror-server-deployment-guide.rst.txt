.. Repository Mirror Server Deployment Guide

.. |br| raw:: html

   <br />

#########################################
Repository Mirror Server Deployment Guide
#########################################

.. toctree::
   :maxdepth: 2
   :caption: Contents:

The following instructions are for deploying a repository mirror host.
This node serves as a front end to the repository files which are stored
on an NFS mount.


*************
Prerequisites
*************

* :doc:`mirror-server-os-installation-guide`
* :doc:`../idm/idm-client-deployment-guide`
* :doc:`../nfs/nfs-client-deployment-guide`


*********************
Follow-on Deployments
*********************

The following guides can be applied after the deployment of their associated nodes.

* :doc:`../graylog/rsyslog-deployment-guide`
* :doc:`../influxdb/telegraf-deployment-guide`


**********
References
**********

..

  Instructions are based on the following documentation: |br|
  https://www.golinuxcloud.com/local-offline-yum-dnf-repo-http-rocky-linux-8/


******************
Deployment Scripts
******************

.. note::

  An example bash script of the instructions has been provided: |br|
  :download:`../_static/mirror/deploy-mirror-server.sh`


****************
Deployment Steps
****************

.. note::

  Instructions assume execution using the ``root`` account.

1. Connect the system to the NFS Server:

  See Guide: :doc:`../nfs/nfs-client-deployment-guide`

2. Connect the system to the IdM Server:

  See Guide: :doc:`../idm/idm-client-deployment-guide`

3. Install dependencies:

  .. code-block:: bash

    dnf -y install nginx yum-utils

4. Create local directory for the repository mount:

  .. code-block:: bash

    mkdir -p /srv/repos/

5. Configure NFS mount:

  .. important::

    Replace ``engwsc.example.com`` with the domain name of your network.

  .. code-block:: bash

    cat >> /etc/fstab <<EOL

    # Repository Mirror NFS Mount
    nfs01.engwsc.example.com:/srv/nfs/mirror /srv/repos nfs4 defaults,tcp,soft,nfsvers=4 0 0
    EOL

6. Mount the mirror path:

  .. code-block:: bash

    mount /srv/repos

6. Create repository paths:

  .. important::

    Replace ``almalinux`` with the ``rocky`` if using Rocky Linux.

  .. code-block:: bash

    mkdir -p /srv/repos/almalinux/8/{baseos,appstream,extras,ha,powertools}

7. Install Extra Packages for Enterprise Linux (EPEL) Repository:

  .. code-block:: bash

    dnf -y install epel-release
    dnf -y distro-sync

8. Add InfluxDB Repository for Telegraf updates:

  .. note::

    Skip this step if Telegraf was previously deployed on this node.

  .. code-block:: bash

    # influxdb.key GPG Fingerprint: 05CE15085FC09D18E99EFB22684A14CF2582E0C5
    cat > /etc/yum.repos.d/influxdb.repo <<EOF
    [influxdb]
    name = InfluxDB Repository - RHEL \$releasever
    baseurl = https://repos.influxdata.com/rhel/\$releasever/\$basearch/stable
    enabled = 1
    gpgcheck = 1
    gpgkey = https://repos.influxdata.com/influxdb.key
    EOF

9. Create a Cron Job to synchronize repositories:

  .. important::

    Replace ``almalinux`` with the ``rocky`` if using Rocky Linux.

  .. code-block:: bash

    cat > /etc/cron.daily/update-localrepos <<EOF
    #!/bin/bash

    /bin/dnf reposync --repoid=baseos        -g --delete --newest-only --download-metadata -p /srv/repos/almalinux/8/
    /bin/dnf reposync --repoid=appstream     -g --delete --newest-only --download-metadata -p /srv/repos/almalinux/8/
    /bin/dnf reposync --repoid=extras        -g --delete --newest-only --download-metadata -p /srv/repos/almalinux/8/
    /bin/dnf reposync --repoid=powertools    -g --delete --newest-only --download-metadata -p /srv/repos/almalinux/8/
    /bin/dnf reposync --repoid=ha            -g --delete --newest-only --download-metadata -p /srv/repos/almalinux/8/
    /bin/dnf reposync --repoid=influxdb      -g --delete --newest-only --download-metadata -p /srv/repos/influxdb/rhel/8/
    /bin/dnf reposync --repoid=epel          -g --delete --newest-only --download-metadata -p /srv/repos/epel/8/
    /bin/dnf reposync --repoid=epel-modular  -g --delete --newest-only --download-metadata -p /srv/repos/epel/8/
    EOF

    chmod 755 /etc/cron.daily/update-localrepos

10. Synchronize repositories:

  .. code-block:: bash

    /etc/cron.daily/update-localrepos

11. Configure Nginx to server the repository over http:

  .. important::

    Replace ``engwsc.example.com`` with the domain name of your network.

  .. code-block:: bash

    cat > /etc/nginx/conf.d/localrepos.conf <<EOF
    server {
        listen      80;
        server_name mirror.engwsc.example.com;
        root        /srv/repos/;
        index       index.html;
        location / {
            autoindex on;
        }
    }
    EOF

12. Set SELinux context and httpd boolean:

  .. code-block:: bash

    # Execute the following if the repository is stored locally
    # chcon -Rt httpd_sys_content_t /srv/repos/

    # Set SELinux boolen to allow httpd to use nfs
    setsebool -P httpd_use_nfs=1

13. Enable Nginx service:

  .. code-block:: bash

    systemctl enable --now nginx
    systemctl status nginx

14. Configure firewall rules:

  .. important::

    Replace the IPv4 Address and Subnet mask with the value of your network.

  .. code-block:: bash

    systemctl enable --now firewalld
    firewall-cmd --zone=public --add-source=192.168.1.0/24 --permanent
    firewall-cmd --zone=public --add-service=http --permanent
    firewall-cmd --reload
